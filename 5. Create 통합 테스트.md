# 5. Create 통합 테스트

### 통합 테스트란?

- **모듈을 통합하는 단계에서 수행하는 테스트**
- 먼저 **단위 테스트**를 수행하여 잘 작동하는지 확인한 후 이 모듈들을 연동해서 테스트를 수행합니다.
- 모듈들의 상호 작용이 잘 이루어지는지 검증합니다.
- 통합하는 과정에서 발생하는 오류를 검출합니다.
- **SuperTest 모듈**을 이용해 통합 테스트를 쉽게 구현할 수 있습니다.

```js
const request = require("supertest");
const app = require("../../server");
const newProduct = require("../data/new-product.json");

it("POST /api", async () => {
  // body 값과 함께 request 요청
  const response = await request(app).post("/api").send(newProduct);

  // response 값을 바탕으로 테스트 진행
  expect(response.statusCode).toBe(201);
  expect(response.body.name).toBe(newProduct.name);
  expect(response.body.description).toBe(newProduct.description);
  expect(response.body.price).toBe(newProduct.price);
});
```



### 에러 처리를 위한 통합테스트

- **Node Express**는 미들웨어에서 **에러가 발생되면 에러 처리기로 전송**합니다.
  - 즉 바로 보내주기 때문에 다음 실행할 미들웨어는 실행되지 않습니다.
- 에러 처리기는 4개의 인자를 가진 미들웨어 입니다.

```js
// 미들웨어
app.get('*', (req, res, next){
  // 에러 처리기로 에러 전송
	throw new Error('Error 발생!')
})

// 에러 처리기
app.use((error, req, res, next){
	res.json({message: error.message});
})
```

- 하지만 비동기 처리에서 발생하는 에러는 에러 처리기에서 에러를 받을 수 없게 됩니다.

```js
// 미들웨어
app.get('*', (req, res, next){
  // 에러 처리기로 에러 전송 실패 => 서버 다운
  setImmediate(()=> { throw new Error('Error 발생!') })
	
})

// 에러 처리기
app.use((error, req, res, next){
	res.json({message: error.message});
})
```

- 비동기 과정에서는  `next()`함수의 인자로 넣어주면 해결할 수 있습니다.

```js
// 미들웨어
app.get('*', (req, res, next){
  // 에러 처리기로 에러 전송 가능
  setImmediate(()=> { next(new Error('Error 발생!')); })
	
})

// 에러 처리기
app.use((error, req, res, next){
	res.json({message: error.message});
})
```

- server.js에 에러 핸들러 추가

```js
const app = express();
app.use(express.json());
app.use("/api", router);

// 에러 핸들러 추가
app.use((err, req, res, next) => {
  res.status(500).json({ message: err.message });
});

app.listen(PORT, () => {
  console.log(`server is listening at localhost:${PORT}`);
});

module.exports = app;
```

- 실제 통합 테스트 작성

```js
it("should return 500 on POST /api", async () => {
  // 에러 발생을 위해 잘못된 body 값을 전송합니다.
  const response = await request(app).post("/api").send({ name: "computer" });
  const errorMessage =
    "Product validation failed: description: Path `description` is required.";

  expect(response.statusCode).toBe(500);

  expect(response.body).toStrictEqual({
    message: errorMessage,
  });
});
```

